---
title: "Analysis of Dataset 1 -  Expression profiling by Array (GSE124226)"
output: pdf_document
date: "2023-12-22"
---

# Data Exploration and Preprocessing

```{r, message = FALSE, results='hide', warning=FALSE}
# Set the CRAN mirror
options(repos = c(CRAN = "https://cran.rstudio.com"))

# Download the package of interest
BiocManager::install('ArrayExpress')
BiocManager::install("affy")
BiocManager::install("limma")
BiocManager::install("siggenes")
BiocManager::install("arrayQualityMetrics")
BiocManager::install("GEOquery")
BiocManager::install("hgu133plus2.db")

#Load the package
library('ArrayExpress')
library("affy")
library("limma")
library("siggenes")
library("arrayQualityMetrics")
library("GEOquery")
library("hgu133plus2.db")
```

The celfiles were downloaded from the NCBI GEO website. Sample info was added manually as the metadata was not present.

```{r}
celpath = "C:/Users/maxim/OneDrive - UGent/1 Master Bio-informatics/Semester 1/Applied High Throughput Analysis/Project/Dataset 1 - GSE124226/celfiles"

sample_info <- data.frame(
  SampleNumber = c("1", "2", "3", "4", "5", "6", "7", "8"),
  SampleName = c("GSM3526020_3004_Control", "GSM3526021_3006_PCOS", "GSM3526022_3010_PCOS", "GSM3526023_3019_PCOS", 
                 "GSM3526024_3027_Control", "GSM3526025_3034_Control", "GSM3526026_3036_Control", "GSM3526027_3042_PCOS"),
  Condition = c("Control", "PCOS", "PCOS", "PCOS", "Control", "Control", "Control", "PCOS") )

# Load in the Affybatch object
PCOSExp <- ReadAffy(celfile.path=celpath, phenoData=sample_info)
```

```{r}
# Have a look to the data you just loaded
head(exprs(PCOSExp))
```

```{r}
pData(PCOSExp)
```

## Quality control

```{r}
arrayQualityMetrics(PCOSExp, intgroup = colnames(pData(PCOSExp))[3], outdir = "QC_rawdata", force = TRUE)
arrayQualityMetrics(PCOSExp, intgroup = colnames(pData(PCOSExp))[3], outdir = "QC_rawdata_log", force = TRUE, do.logtransform = TRUE)
```

## Preprocessing

A boxplot is used to check the distribution of the expression data.

```{r}
boxplot(PCOSExp)
```

Although the boxplots are similar, they can be further optimized. Using the rma function of the affy package, background correction and quantile normalisation is performed.

```{r}
# Background correction, quantile normalisation
PCOSRMA <- affy::rma(PCOSExp)
```

Again, a boxplot is used to check the distribution of the expression data that has been background corrected and quantile normalised.

```{r}
boxplot(PCOSRMA)
```

The boxplots are now ideal, showing an equal mean, equal quantiles and equal variances.

## Quality control on processed data

RMA produces logtransformed data => do.logtransform = FALSE

```{r}
arrayQualityMetrics(PCOSRMA, intgroup = colnames(pData(PCOSExp))[3], outdir = "QC_preprocessed", force = TRUE, do.logtransform = FALSE)
```

# Differential Expression Analysis

A design matrix is made. There is no intercept.

```{r}
design <- model.matrix(~ 0 + factor(c(1,2,2,2,1,1,1,2)))
colnames(design) <- c("control", "PCOS")
design
```

A linear model is fit to the expression data.

```{r}
fit <- lmFit(PCOSRMA, design)
contrast.matrix <- makeContrasts(PCOS-control, levels=design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
```

Top Genes are called.

```{r}
LIMMAout <- topTable(fit2, 
                     coef = 1, # which contrast do you want to test, 1 is without intercept, 2 is with intercept
                     adjust = 'BH', # Benjamini-Hochberg procedure
                     number=Inf)
head(LIMMAout)
```

Volcano plot

```{r}
jpeg("Volcanoplotdataset1.jpg")
limma::volcanoplot(fit2)
dev.off()
limma::volcanoplot(fit2)
```

MA plot

```{r}
jpeg("MAplotdataset1.jpg")
limma::plotMA(fit2)
dev.off()
limma::plotMA(fit2)
```

# Gene Set Analysis

## Gene annotation

As the package WebGestaltR is used, which requires EntrezIDs or Ensembl IDs to perform an Over Representation Analysis, annotation of the genes is performed first.

```{r}
# Get gene annotations based on probe IDs
probe_ids <- rownames(LIMMAout)
gene_annotations <- select(hgu133plus2.db, keys = probe_ids, columns = c("SYMBOL", "GENENAME", "ENTREZID", "GENENAME"), keytype = "PROBEID")

duplicate_probes <- probe_ids[duplicated(gene_annotations$PROBEID)]
cat("Duplicate probe IDs found:", length(duplicate_probes), "\n")

# Remove duplicate rows (keeping the first occurrence)
gene_annotations_unique <- gene_annotations[!duplicated(gene_annotations$PROBEID), ]

# Sort gene_annotations_unique by probe name alphabetically
gene_annotations_unique_sorted <- gene_annotations_unique[order(gene_annotations_unique$PROBEID), ]

# Sort LIMMA output alphabetically on probe name
LIMMAout_sorted <- LIMMAout[sort(rownames(LIMMAout), index.return=T)$ix, ]

# Add gene names to LIMMA output
LIMMAout_sorted$Gene <- gene_annotations_unique_sorted$GENENAME
LIMMAout_sorted$Symbol <- gene_annotations_unique_sorted$SYMBOL
LIMMAout_sorted$EntrezID <- gene_annotations_unique_sorted$ENTREZID
LIMMAout_sorted$Gene <- as.character(LIMMAout_sorted$Gene)
LIMMAout_sorted$Symbol <- as.character(LIMMAout_sorted$Symbol)
LIMMAout_sorted$EntrezID <- as.character(LIMMAout_sorted$EntrezID)

LIMMAout_annot <- LIMMAout_sorted[sort(LIMMAout_sorted$P.Value, index.return = T)$ix,]
head(LIMMAout_annot)
```

## Over Representation Analysis

The top 300 genes are selected based on p-value and logFC, these genes are most likely to be differently expressed.

```{r}
logFC_interest <- LIMMAout_annot[abs(LIMMAout_annot$logFC) > 0.7, ]
logFC_interest_sorted <- logFC_interest[sort(logFC_interest$P.Value, index.return = T)$ix, ]
top_genes <- head(logFC_interest_sorted, 300)
head(top_genes)
```

From these genes, we select the upregulated and downregulated genes. We store the entrez ids of these genes for further use in the Over Representation Analysis. The reference gene set is equal to all genes in the array.

```{r}
# Upregulated genes
upreg_genes <- top_genes$EntrezID[top_genes$logFC > 0]
upreg_genes <- upreg_genes[!is.na(upreg_genes)]
cat("Number of downregulated genes:", length(upreg_genes), "\n")

# Downregulated genes
downreg_genes <- top_genes$EntrezID[top_genes$logFC < 0]
downreg_genes <- downreg_genes[!is.na(downreg_genes)]
cat("Number of downregulated genes:", length(downreg_genes), "\n")

# Reference genes
ref_genes <- LIMMAout_annot$EntrezID[!is.na(LIMMAout_annot$EntrezID)]
cat("Number of reference genes:", length(ref_genes), "\n")
```

### KEGG

```{r}
# Perform KEGG pathway analysis on the upregulated genes
kegg_upreg <- limma::kegga(de = upreg_genes, universe = ref_genes, species = "Hs")

# Sort results and calculate FDR
kegg_upreg <- kegg_upreg[sort(kegg_upreg$P.DE, index.return=T)$ix, ]
kegg_upreg$P.DE.adj <- p.adjust(kegg_upreg$P.DE, n=nrow(kegg_upreg), method="BH")
head(kegg_upreg)
```


```{r}
# Perform KEGG pathway analysis on the downregulated genes
kegg_downreg <- limma::kegga(de = downreg_genes, universe = ref_genes, species = "Hs")

# Print or further process the results
# Sort results and calculate FDR
kegg_downreg <- kegg_downreg[sort(kegg_downreg$P.DE, index.return=T)$ix, ]
kegg_downreg$P.DE.adj <- p.adjust(kegg_downreg$P.DE, n=nrow(kegg_downreg), method="BH")
head(kegg_downreg)
```

### Gene Ontology: Molecular Function (MF)

```{r}
# Perform Gene Ontology: Molecular Function Analysis on the upregulated genes
goana_upreg <- limma::goana(de = upreg_genes, universe = ref_genes, species = "Hs")

# Print or further process the results
goana_upreg <- goana_upreg[goana_upreg$Ont == "MF", ]
goana_upreg <- goana_upreg[sort(goana_upreg$P.DE, index.return=T)$ix, ]
goana_upreg$P.DE.adj <- p.adjust(goana_upreg$P.DE, n=nrow(goana_upreg), method="BH")
head(goana_upreg)
```

```{r}
# Perform Gene Ontology: Molecular Function Analysis using WebGestaltR on the downregulated genes
goana_downreg <- limma::goana(de = downreg_genes, universe = ref_genes, species = "Hs")

# Print or further process the results
goana_downreg <- goana_downreg[goana_downreg$Ont == "MF", ]
goana_downreg <- goana_downreg[sort(goana_downreg$P.DE, index.return=T)$ix, ]
goana_downreg$P.DE.adj <- p.adjust(goana_downreg$P.DE, n=nrow(goana_downreg), method="BH")
head(goana_downreg)
```


# Writing out Data for comparison

Results of the analysis of Dataset 1 are saved for comparison between dataset analysis.
The results of limma analysis are saved in txt file for further use.

```{r}
write.table(LIMMAout_annot, sep= "\t", file="Dataset1_limma_results.txt")
```

The results of gene set analysis are saved in a txt file for further use.

```{r}
write.table(kegg_upreg, sep= "\t", file="Dataset1_PathwayAnalysis_upreg_results.txt")
write.table(kegg_downreg, sep= "\t", file="Dataset1_PathwayAnalysis_downreg_results.txt")
write.table(goana_upreg, sep= "\t", file="Dataset1_MolecularFunction_upreg_results.txt")
write.table(goana_downreg, sep= "\t", file="Dataset1_MolecularFunction_downreg_results.txt")
```

